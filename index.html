<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOBREAVISO RADIOLOGIA</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0056b3">

    <style>
        :root {
            --primary: #0056b3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #fd7e14;
            --info: #17a2b8;
            --bg: #f0f2f5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #333; }
        
        #app-content { display: block; padding: 10px; padding-bottom: 40px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .app-header { display: flex; flex-direction: column; gap: 15px; border-bottom: 2px solid #f0f2f5; padding-bottom: 15px; margin-bottom: 15px; }
        @media (min-width: 768px) { .app-header { flex-direction: row; justify-content: space-between; align-items: center; } }
        
        .header-title h2 { margin: 0; color: var(--primary); font-size: 1.4rem; text-align: center; }
        
        .system-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        @media (min-width: 768px) { .system-controls { display: flex; } }

        .btn-sys { border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.8rem; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-backup { background: var(--warning); }
        .btn-restore { background: #20c997; }
        .btn-print { background: #6610f2; }
        .btn-requisicao { background: #e83e8c; }

        .user-config { background: #e7f3ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; }
        @media (min-width: 600px) { .user-config { flex-direction: row; align-items: center; } }
        .user-config input { flex: 1; padding: 10px; border: 1px solid #b6d4fe; border-radius: 6px; font-size: 1rem; }

        .escalas-container { background: #fff3cd; padding: 15px; border: 1px solid #ffeeba; border-radius: 10px; margin-bottom: 15px; }
        .escala-item { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); align-items: end; }
        @media (min-width: 768px) { .escala-item { grid-template-columns: 2fr 1fr 1fr auto; } }
        .btn-del-escala { background: var(--danger); color: white; border: none; border-radius: 6px; padding: 10px; cursor: pointer; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; border: none; background: #eee; font-weight: bold; color: #666; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: var(--primary); color: white; }

        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        @media (min-width: 768px) { .grid-inputs { grid-template-columns: repeat(3, 1fr); } }
        
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: bold; font-size: 0.75rem; color: #666; text-transform: uppercase; }
        .form-group input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; width: 100%; }

        .table-responsive { width: 100%; overflow-x: auto; border: 1px solid #eee; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background: #f4f7fa; color: var(--primary); }
        
        .btn-add-main { background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; width: 100%; margin-bottom: 20px; }
        .actions { display: flex; gap: 10px; }
        .btn-edit { color: var(--info); cursor: pointer; background: none; border: none; font-size: 1.1rem; }
        .btn-del { color: var(--danger); cursor: pointer; background: none; border: none; font-size: 1.1rem; }

        @media print {
            body { background: white !important; }
            #app-content { display: none !important; }
            #print-relatorio.active, #print-requisicoes.active { display: block !important; }
            .table-print { width: 100%; border-collapse: collapse; }
            .table-print th, .table-print td { border: 1px solid black !important; padding: 6px; font-size: 10pt; }
            .ficha { width: 100%; height: 8.8cm; border: 1.5px solid black; padding: 15px; page-break-inside: avoid; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

<div id="app-content">
    <div class="container">
        <header class="app-header">
            <div class="header-title"><h2>SOBREAVISO RADIOLOGIA</h2></div>
            <div class="system-controls">
                <button class="btn-sys btn-backup" onclick="fazerBackup()">üíæ Backup</button>
                <button class="btn-sys btn-restore" onclick="document.getElementById('fileInput').click()">üìÇ Abrir</button>
                <button class="btn-sys btn-print" onclick="imprimirRelatorio()">üñ®Ô∏è PDF</button>
                <button class="btn-sys btn-requisicao" onclick="imprimirTodasFichas()">üìÑ Fichas</button>
                <input type="file" id="fileInput" style="display:none" onchange="restaurarBackup(this)">
            </div>
        </header>

        <section class="user-config">
            <label>PROFISSIONAL:</label>
            <input type="text" id="userName" placeholder="NOME COMPLETO" oninput="salvarDados()">
        </section>

        <section class="escalas-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <label style="font-weight:bold; color:#856404; font-size:0.8rem;">PER√çODOS DE ESCALA</label>
                <button onclick="addEscala()" style="background:#856404; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">+ Adicionar Escala</button>
            </div>
            <div id="lista-escalas"></div>
        </section>

        <nav class="tabs">
            <button class="tab-btn active" onclick="tab(event, 'exames')">üìã EXAMES</button>
            <button class="tab-btn" onclick="tab(event, 'corridas')">CORRIDAS</button>
        </nav>

        <div id="exames" class="tab-content">
            <input type="hidden" id="ex-edit-id">
            <div class="grid-inputs">
                <div class="form-group"><label>Data</label><input type="date" id="ex-data"></div>
                <div class="form-group"><label>Entrada</label><input type="time" id="ex-in"></div>
                <div class="form-group"><label>Sa√≠da</label><input type="time" id="ex-out"></div>
                <div class="form-group"><label>Setor</label><input type="text" id="ex-setor" list="setores" oninput="this.value=this.value.toUpperCase()"></div>
                <div class="form-group"><label>Exame</label><input type="text" id="ex-nome" oninput="this.value=this.value.toUpperCase()"></div>
                <div class="form-group"><label>Paciente</label><input type="text" id="ex-pac" oninput="this.value=this.value.toUpperCase()"></div>
            </div>
            <button class="btn-add-main" id="btn-salvar-exame" onclick="addExame()">ADICIONAR EXAME</button>
            
            <div class="table-responsive">
                <table id="tbl-exames">
                    <thead><tr><th>Data</th><th>Ent</th><th>Sai</th><th>Tempo</th><th>Setor</th><th>A√ß√µes</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="corridas" class="tab-content" style="display:none">
            <input type="hidden" id="co-edit-id">
            <div class="grid-inputs">
                <div class="form-group"><label>Data</label><input type="date" id="co-data"></div>
                <div class="form-group"><label>KM Rodados</label><input type="number" step="0.1" id="co-km"></div>
                <div class="form-group"><label>Obs</label><input type="text" id="co-obs" oninput="this.value=this.value.toUpperCase()"></div>
            </div>
            <button class="btn-add-main" id="btn-salvar-corrida" onclick="addCorrida()">ADICIONAR CORRIDA</button>
            <div class="table-responsive">
                <table id="tbl-corridas">
                    <thead><tr><th>Data</th><th>KM</th><th>Observa√ß√£o</th><th>A√ß√µes</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<datalist id="setores"><option value="SUE"><option value="RIO NEGRO"><option value="UTI 1"><option value="UTI 2"><option value="UTI 3"><option value="UTI 4"></datalist>

<div id="print-relatorio" style="display:none">
    <div style="text-align:center; border:1px solid #000; padding:15px; margin-bottom:20px;">
        <h2 style="margin:0">RELAT√ìRIO SOBREAVISO - RADIOLOGIA</h2>
        <p id="pr-nome" style="font-size:16pt; font-weight:bold; margin:10px 0;"></p>
        <p id="pr-periodo" style="margin:0; font-size:10pt;"></p>
    </div>
    <table class="table-print" id="pr-tbl-ex">
        <thead><tr><th>DATA</th><th>ENTRADA</th><th>SA√çDA</th><th>TEMPO</th><th>SETOR</th><th>EXAME</th><th>PACIENTE</th></tr></thead>
        <tbody></tbody>
    </table>
    <div style="margin-top:20px;">
        <p>QTD CORRIDAS: <span id="pr-qtd-co"></span> | TOTAL KM: <span id="pr-km-co"></span></p>
        <p>HORAS TRABALHADAS: <span id="pr-total-trabalho"></span> | TOTAL SOBREAVISO: <span id="pr-total-escala"></span></p>
    </div>
</div>

<div id="print-requisicoes" style="display:none"></div>

<script>
    let db = { user: "", escalas: [], exames: [], corridas: [] };

    function tab(e, n) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(n).style.display = 'block';
        e.currentTarget.classList.add('active');
    }

    // --- ESCALAS ---
    function addEscala(data="", inT="", dataF="", outT="") {
    const div = document.createElement('div');
    div.className = 'escala-item';
    div.innerHTML = `
        <div class="form-group"><label>Data In√≠cio</label><input type="date" class="sc-data" value="${data}" onchange="salvarDados()"></div>
        <div class="form-group"><label>Hora In√≠cio</label><input type="time" class="sc-in" value="${inT}" onchange="salvarDados()"></div>
        <div class="form-group"><label>Data Fim</label><input type="date" class="sc-data-f" value="${dataF}" onchange="salvarDados()"></div>
        <div class="form-group"><label>Hora Fim</label><input type="time" class="sc-out" value="${outT}" onchange="salvarDados()"></div>
        <button onclick="this.parentElement.remove();salvarDados()" style="background:#dc3545; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer">Remover</button>
    `;
    document.getElementById('lista-escalas').appendChild(div);
}

    // --- EXAMES ---
    function addExame() {
        const idEdit = document.getElementById('ex-edit-id').value;
        const item = {
            id: idEdit ? parseInt(idEdit) : Date.now(),
            data: document.getElementById('ex-data').value,
            in: document.getElementById('ex-in').value,
            out: document.getElementById('ex-out').value,
            setor: document.getElementById('ex-setor').value,
            nome: document.getElementById('ex-nome').value,
            pac: document.getElementById('ex-pac').value,
            tempo: calcDiff(document.getElementById('ex-in').value, document.getElementById('ex-out').value)
        };
        if(!item.data || !item.in) return alert("Preencha data e entrada");

        if(idEdit) {
            const index = db.exames.findIndex(x => x.id == idEdit);
            db.exames[index] = item;
        } else {
            db.exames.push(item);
        }
        
        limparExame();
        salvarDados();
    }

    function editarExame(id) {
        const ex = db.exames.find(x => x.id == id);
        document.getElementById('ex-edit-id').value = ex.id;
        document.getElementById('ex-data').value = ex.data;
        document.getElementById('ex-in').value = ex.in;
        document.getElementById('ex-out').value = ex.out;
        document.getElementById('ex-setor').value = ex.setor;
        document.getElementById('ex-nome').value = ex.nome;
        document.getElementById('ex-pac').value = ex.pac;
        document.getElementById('btn-salvar-exame').innerText = "ATUALIZAR EXAME";
        document.getElementById('btn-salvar-exame').style.background = "var(--info)";
    }

    function limparExame() {
        document.getElementById('ex-edit-id').value = "";
        ['ex-data','ex-in','ex-out','ex-setor','ex-nome','ex-pac'].forEach(id => document.getElementById(id).value = "");
        document.getElementById('btn-salvar-exame').innerText = "ADICIONAR EXAME";
        document.getElementById('btn-salvar-exame').style.background = "var(--success)";
    }

    // --- CORRIDAS ---
    function addCorrida() {
        const idEdit = document.getElementById('co-edit-id').value;
        const item = {
            id: idEdit ? parseInt(idEdit) : Date.now(),
            data: document.getElementById('co-data').value,
            km: document.getElementById('co-km').value,
            obs: document.getElementById('co-obs').value
        };
        if(!item.data || !item.km) return alert("Preencha data e KM");

        if(idEdit) {
            const index = db.corridas.findIndex(x => x.id == idEdit);
            db.corridas[index] = item;
        } else {
            db.corridas.push(item);
        }
        
        limparCorrida();
        salvarDados();
    }

    function editarCorrida(id) {
        const co = db.corridas.find(x => x.id == id);
        document.getElementById('co-edit-id').value = co.id;
        document.getElementById('co-data').value = co.data;
        document.getElementById('co-km').value = co.km;
        document.getElementById('co-obs').value = co.obs;
        document.getElementById('btn-salvar-corrida').innerText = "ATUALIZAR CORRIDA";
        document.getElementById('btn-salvar-corrida').style.background = "var(--info)";
    }

    function limparCorrida() {
        document.getElementById('co-edit-id').value = "";
        ['co-data','co-km','co-obs'].forEach(id => document.getElementById(id).value = "");
        document.getElementById('btn-salvar-corrida').innerText = "ADICIONAR CORRIDA";
        document.getElementById('btn-salvar-corrida').style.background = "var(--success)";
    }

    // --- CORE ---
    function del(t, id) { if(confirm('Excluir?')){ db[t] = db[t].filter(i => i.id !== id); salvarDados(); } }

    function salvarDados() {
    db.user = document.getElementById('userName').value;
    db.escalas = [];
    document.querySelectorAll('.escala-item').forEach(item => {
        db.escalas.push({
            data: item.querySelector('.sc-data').value,
            in: item.querySelector('.sc-in').value,
            dataF: item.querySelector('.sc-data-f').value, // Novo campo
            out: item.querySelector('.sc-out').value
        });
    });
    localStorage.setItem('radiologiaDB', JSON.stringify(db));
    render();
}

    function render() {
        document.querySelector('#tbl-exames tbody').innerHTML = db.exames.map(ex => `
            <tr>
                <td>${fmtD(ex.data)}</td><td>${ex.in}</td><td>${ex.out}</td><td>${ex.tempo}</td><td>${ex.setor}</td>
                <td class="actions">
                    <button class="btn-edit" onclick="editarExame(${ex.id})">‚úèÔ∏è</button>
                    <button class="btn-del" onclick="del('exames',${ex.id})">‚úñ</button>
                </td>
            </tr>`).join('');

        document.querySelector('#tbl-corridas tbody').innerHTML = db.corridas.map(co => `
            <tr>
                <td>${fmtD(co.data)}</td><td>${co.km}</td><td>${co.obs}</td>
                <td class="actions">
                    <button class="btn-edit" onclick="editarCorrida(${co.id})">‚úèÔ∏è</button>
                    <button class="btn-del" onclick="del('corridas',${co.id})">‚úñ</button>
                </td>
            </tr>`).join('');
    }

   // Calcula diferen√ßa entre datas e horas (Retorna total em minutos)
function calcDiffFull(d1, t1, d2, t2) {
    if(!d1 || !t1 || !d2 || !t2) return 0;
    const start = new Date(`${d1}T${t1}`);
    const end = new Date(`${d2}T${t2}`);
    const diffMs = end - start;
    return diffMs > 0 ? Math.floor(diffMs / 60000) : 0;
}
// Formata minutos em "00:00" ou "Xh Ym"
function fmtMinutos(totalMinutos) {
    let h = Math.floor(totalMinutos / 60);
    let m = totalMinutos % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}
    function fmtD(d) { if(!d) return ""; const [y,m,dia] = d.split('-'); return `${dia}/${m}/${y}`; }

    function carregar() {
    const saved = localStorage.getItem('radiologiaDB');
    if(saved) {
        db = JSON.parse(saved);
        document.getElementById('userName').value = db.user;
        // Atualizado para passar os 4 par√¢metros
        db.escalas.forEach(e => addEscala(e.data, e.in, e.dataF || e.data, e.out));
        render();
    }
}

    function fazerBackup() {
        const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `backup_radiologia.json`;
        a.click();
    }

    function restaurarBackup(input) {
        const reader = new FileReader();
        reader.onload = e => {
            db = JSON.parse(e.target.result);
            localStorage.setItem('radiologia_v11_edit', JSON.stringify(db));
            location.reload();
        };
        reader.readAsText(input.files[0]);
    }

    function imprimirRelatorio() {
    document.getElementById('pr-nome').innerText = db.user.toUpperCase();
    // Ajuste na exibi√ß√£o do per√≠odo no PDF
    document.getElementById('pr-periodo').innerText = db.escalas.map(e => 
        `${fmtD(e.data)} ${e.in} at√© ${fmtD(e.dataF)} ${e.out}`
    ).join(' | ');
    
    const tbody = document.querySelector('#pr-tbl-ex tbody');
    tbody.innerHTML = db.exames.map(ex => `<tr><td>${fmtD(ex.data)}</td><td>${ex.in}</td><td>${ex.out}</td><td>${ex.tempo}</td><td>${ex.setor}</td><td>${ex.nome}</td><td>${ex.pac}</td></tr>`).join('');
    
    document.getElementById('pr-qtd-co').innerText = db.corridas.length;
    document.getElementById('pr-km-co').innerText = db.corridas.reduce((s, c) => s + (parseFloat(c.km)||0), 0).toFixed(1);
    
    // Soma horas trabalhadas (Exames)
    let totalMinTrabalho = db.exames.reduce((acc, ex) => {
        let [h, m] = ex.tempo.split(':').map(Number);
        return acc + (h * 60 + m);
    }, 0);
    document.getElementById('pr-total-trabalho').innerText = `${Math.floor(totalMinTrabalho/60)}h ${totalMinTrabalho%60}m`;
    
    // Soma total de Sobreaviso (Escalas)
    let totalMinEscala = db.escalas.reduce((acc, e) => {
        return acc + calcDiffFull(e.data, e.in, e.dataF, e.out);
    }, 0);
    document.getElementById('pr-total-escala').innerText = `${Math.floor(totalMinEscala/60)}h ${totalMinEscala%60}m`;

    window.printRelatorio();
}

    function imprimirTodasFichas() {
        const area = document.getElementById('print-requisicoes');
        area.innerHTML = db.exames.map(ex => `
            <div class="ficha">
                <div style="text-align:center;font-weight:bold;border-bottom:1px solid #000;padding-bottom:5px;margin-bottom:10px;">REQUISI√á√ÉO PARA EXAME RAIO-X / TOMOGRAFIA</div>
                <div style="display:flex;margin-bottom:10px"><span>Data: ${fmtD(ex.data)}</span><span style="margin-left:auto">SIM [X] N√ÉO [ ]</span></div>
                <div style="margin-bottom:10px">Entrada: ${ex.in} | Sa√≠da: ${ex.out}</div>
                <div style="margin-bottom:10px">Setor: ${ex.setor}</div>
                <div style="margin-bottom:10px">T√©cnico: ${db.user.toUpperCase()}</div>
                <div style="display:flex;justify-content:space-between;margin-top:60px">
                    <div style="border-top:1px solid #000;width:40%;text-align:center;font-size:8pt">Respons√°vel</div>
                    <div style="border-top:1px solid #000;width:40%;text-align:center;font-size:8pt">T√©cnico</div>
                </div>
            </div>
        `).join('');
        document.getElementById('print-requisicoes').classList.add('active');
        document.getElementById('print-relatorio').classList.remove('active');
        window.print();
    }

    window.onload = carregar;
</script>
</body>
</html>
